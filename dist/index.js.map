{"version":3,"sources":["../src/index.js"],"names":["ImageminPlugin","options","disable","test","minFileSize","maxFileSize","Infinity","maxConcurrency","length","plugins","externalImages","cacheFolder","imageminOptions","testFunction","context","sources","destination","push","compiler","compilerOptions","onEmit","compilation","callback","throttle","all","optimizeWebpackImages","optimizeExternalImages","hooks","emit","tapAsync","constructor","name","plugin","assets","asset","filename","assetSource","source","optimizedImageBuffer","fullContext","resolve","invokedDestination","relativeFilePath","relative","fileData","writeFilePath","join"],"mappings":"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","file":"index.js","sourcesContent":["import path from 'path'\nimport { cpus } from 'os'\nimport map from 'lodash.map'\nimport createThrottle from 'async-throttle'\nimport RawSource from 'webpack-sources/lib/RawSource'\n\nimport {\n  buildTestFunction,\n  invokeIfFunction,\n  getFromCacheIfPossible,\n  readFile,\n  writeFile,\n  optimizeImage\n} from './helpers.js'\n\nexport default class ImageminPlugin {\n  constructor (options = {}) {\n    // I love ES2015!\n    const {\n      disable = false,\n      test = /.*/,\n      minFileSize = 0,\n      maxFileSize = Infinity,\n      maxConcurrency = cpus().length,\n      plugins = [],\n      externalImages = {},\n      cacheFolder = null\n    } = options\n\n    this.options = {\n      disable,\n      maxConcurrency,\n      imageminOptions: {\n        plugins: []\n      },\n      testFunction: buildTestFunction(test, minFileSize, maxFileSize),\n      externalImages: {\n        context: '.',\n        sources: [],\n        destination: '.',\n        ...externalImages\n      },\n      cacheFolder\n    }\n\n    // And finally, add any plugins that they pass in the options to the internal plugins array\n    this.options.imageminOptions.plugins.push(...plugins)\n  }\n\n  apply (compiler) {\n    // Add the compiler options to my options\n    this.options.compilerOptions = compiler.options\n\n    // If disabled, short-circuit here and just return\n    if (this.options.disable === true) return null\n\n    // Access the assets once they have been assembled\n    const onEmit = async (compilation, callback) => {\n      // Create a throttle object which will limit the number of concurrent processes running\n      const throttle = createThrottle(this.options.maxConcurrency)\n\n      try {\n        // Optimise all images at the same time (throttled to maxConcurrency)\n        // and await until all of them to complete\n        await Promise.all([\n          ...this.optimizeWebpackImages(throttle, compilation),\n          ...this.optimizeExternalImages(throttle)\n        ])\n\n        // At this point everything is done, so call the callback without anything in it\n        callback()\n      } catch (err) {\n        // if at any point we hit a snag, pass the error on to webpack\n        callback(err)\n      }\n    }\n\n    // Check if the webpack 4 plugin API is available\n    if (compiler.hooks) {\n      // Register emit event listener for webpack 4\n      compiler.hooks.emit.tapAsync(this.constructor.name, onEmit)\n    } else {\n      // Register emit event listener for older webpack versions\n      compiler.plugin('emit', onEmit)\n    }\n  }\n\n  /**\n   * Optimize images from webpack and put them back in the asset array when done\n   * @param  {Function} throttle       The setup throttle library\n   * @param  {Object} compilation      The compilation from webpack-sources\n   * @return {Promise[]}               An array of promises that resolve when each image is done being optimized\n   */\n  optimizeWebpackImages (throttle, compilation) {\n    const {\n      testFunction,\n      cacheFolder\n    } = this.options\n\n    // Return an array of promises that resolve when each file is done being optimized\n    // pass everything through the throttle function to limit maximum concurrency\n    return map(compilation.assets, (asset, filename) => throttle(async () => {\n      const assetSource = asset.source()\n      // Skip the image if it's not a match for the regex or it's too big/small\n      if (testFunction(filename, assetSource)) {\n        // Use the helper function to get the file from cache if possible, or\n        // run the optimize function and store it in the cache when done\n        let optimizedImageBuffer = await getFromCacheIfPossible(cacheFolder, filename, () => {\n          return optimizeImage(assetSource, this.options.imageminOptions)\n        })\n\n        // Then write the optimized version back to the asset object as a \"raw source\"\n        compilation.assets[filename] = new RawSource(optimizedImageBuffer)\n      }\n    }))\n  }\n\n  /**\n   * Optimizes external images\n   * @param  {Function} throttle The setup throttle library\n   * @return {Promise[]}         An array of promises that resolve when each image is done being optimized\n   */\n  optimizeExternalImages (throttle) {\n    const {\n      compilerOptions,\n      externalImages: {\n        context,\n        sources,\n        destination\n      },\n      testFunction,\n      cacheFolder\n    } = this.options\n\n    const fullContext = path.resolve(compilerOptions.context, context)\n\n    const invokedDestination = path.resolve(invokeIfFunction(destination))\n\n    return map(invokeIfFunction(sources), (filename) => throttle(async () => {\n      const relativeFilePath = path.relative(fullContext, filename)\n      const fileData = await readFile(path.resolve(fullContext, relativeFilePath))\n      if (testFunction(filename, fileData)) {\n        const writeFilePath = path.join(invokedDestination, relativeFilePath)\n\n        // Use the helper function to get the file from cache if possible, or\n        // run the optimize function and store it in the cache when done\n        let optimizedImageBuffer = await getFromCacheIfPossible(cacheFolder, relativeFilePath, async () => {\n          return optimizeImage(fileData, this.options.imageminOptions)\n        })\n\n        // Write the file to the destination when done\n        return writeFile(writeFilePath, optimizedImageBuffer)\n      }\n    }))\n  }\n}\n"]}